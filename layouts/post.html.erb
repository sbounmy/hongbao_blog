<%= render_layout "body" do %>
  <%# Twitter Widget Script for tweet embeds in blog posts %>
  <%= javascript_include_tag "https://platform.twitter.com/widgets.js", async: true, "data-turbo-track": "reload" %>

  <!-- Hero Image Section -->
  <% if current_page.data["image"] %>
    <div class="relative w-full h-[400px] md:h-[500px] -mt-20 mb-12">
      <%= image_tag current_page.data["image"],
          class: "absolute inset-0 w-full h-full object-cover",
          alt: current_page.data["title"] %>
      <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>

      <!-- Title Overlay -->
      <div class="absolute bottom-0 left-0 right-0 p-8 md:p-12 text-gray-100">
        <div class="max-w-4xl mx-auto">
          <h1 class="text-4xl md:text-5xl font-bold mb-4"><%= current_page.data["title"] %></h1>
          <div class="flex items-center text-sm md:text-base opacity-90">
            <% if current_page.data["date"] %>
              <time datetime="<%= current_page.data["date"] %>">
                <%= Date.parse(current_page.data["date"].to_s).strftime('%B %d, %Y') %>
              </time>
            <% end %>
            <% if current_page.data["author"] %>
              <span class="mx-2">•</span>
              <span><%= current_page.data["author"] %></span>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <!-- No Hero Image - Standard Layout -->
    <div class="max-w-4xl mx-auto px-4 pt-12 pb-8">
      <h1 class="text-4xl md:text-5xl font-bold mb-4"><%= current_page.data["title"] %></h1>
      <div class="flex items-center text-sm text-base-content/60">
        <% if current_page.data["date"] %>
          <time datetime="<%= current_page.data["date"] %>">
            <%= Date.parse(current_page.data["date"].to_s).strftime('%B %d, %Y') %>
          </time>
        <% end %>
        <% if current_page.data["author"] %>
          <span class="mx-2">•</span>
          <span><%= current_page.data["author"] %></span>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Post Content with Sidebar TOC -->
  <div class="max-w-7xl mx-auto px-4 pb-12">
    <div class="lg:grid lg:grid-cols-[1fr_250px] lg:gap-8">
      <!-- Main Content -->
      <div class="prose prose-lg max-w-none" id="post-content">
        <%= yield %>

        <% if publish_at = date(current_page.data["publish_at"]) %>
          <hr class="my-8">
          <p class="text-sm text-base-content/60">This post was published <%= publish_at.to_s(:long_ordinal) %></p>
        <% end %>
      </div>

      <!-- Sticky Sidebar TOC (desktop only) -->
      <aside class="hidden lg:block">
        <nav class="sticky top-24" id="toc-sidebar">
          <h3 class="text-sm font-semibold text-base-content/70 uppercase tracking-wider mb-4">Contents</h3>
          <ul class="space-y-2 text-sm" id="toc-list">
            <!-- Auto-populated by JavaScript -->
          </ul>
        </nav>
      </aside>
    </div>
  </div>

  <script>
    // Auto-generate TOC from H2 headings
    document.addEventListener('DOMContentLoaded', function() {
      const content = document.getElementById('post-content');
      const tocList = document.getElementById('toc-list');
      const headings = content.querySelectorAll('h2');

      headings.forEach(function(heading) {
        // Skip "En bref" heading - it's a summary, not a section
        if (heading.textContent.toLowerCase().includes('en bref')) return;

        // Create ID if not present
        if (!heading.id) {
          heading.id = heading.textContent
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/(^-|-$)/g, '');
        }

        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#' + heading.id;
        a.textContent = heading.textContent;
        a.className = 'text-base-content/60 hover:text-primary transition-colors block py-1 border-l-2 border-transparent hover:border-primary pl-3 -ml-px';
        li.appendChild(a);
        tocList.appendChild(li);
      });

      // Hide TOC if no headings
      if (tocList.children.length === 0) {
        document.getElementById('toc-sidebar').style.display = 'none';
      }
    });
  </script>
<% end %>